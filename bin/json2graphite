#! /usr/bin/env ruby

require 'json'
require 'timeout'
require 'pp'

def walk_the_forrest (obj=self, path=[], &blk)
  obj.each do |key,value|
    case value
    when Hash
      walk_the_forrest(value, [*path, key], &blk)
    else
      blk.call("#{[*path, key].join('.')}",value)
    end
  end
end

def to_graphite (hash)
  data = {}
  now = Time.now.to_i
  walk_the_forrest(hash) {|target, value|
    puts "#{target} #{value} #{now}"
  }
end

def run
  body = ''
  Timeout.timeout(1) do
    body += STDIN.read
    hash = JSON.parse(body)
    data = to_graphite(hash)
  end
end

run()

